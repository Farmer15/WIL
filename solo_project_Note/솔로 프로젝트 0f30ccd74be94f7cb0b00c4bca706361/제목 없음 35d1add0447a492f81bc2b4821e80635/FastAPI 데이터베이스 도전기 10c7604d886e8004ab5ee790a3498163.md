# FastAPI ë°ì´í„°ë² ì´ìŠ¤ ë„ì „ê¸°

ë‚ ì§œ: 2024ë…„ 9ì›” 25ì¼ â†’ 2024ë…„ 9ì›” 26ì¼

### ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

- `Optional` : ì˜µì…˜ìœ¼ë¡œ ì¤˜ë„ ë˜ê³  ì•ˆì¤˜ë„ ë˜ëŠ”ê²ƒì„ ëœ»í•©ë‹ˆë‹¤.
    
    ```python
    class userSchema(BaseModel):
        id: Optional[str] = Field(alias="_id")
    ```
    
- `Field` í•„ë“œë¥¼ ì •ì˜í• ë•Œ ì—¬ëŸ¬ê°€ì§€ ì†ì„±ì„ ë¶€ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - **`default` :** ê¸°ë³¸ì´ ë˜ëŠ” ê°’ ì§€ì • ê°€ëŠ¥
        
        ```python
        class userSchema(BaseModel):
            nick_name: str = Field(default: "ê¸°ë³¸ì´ë¦„ì´ì•¼"
        ```
        
    - **`default_factory` :** ê¸°ë³¸ì´ ë˜ëŠ” í•¨ìˆ˜ë¥¼ ì§€ì • ë™ì ì¸ ê¸°ë³¸ê°’ì´ í•„ìš”í• ë•Œ ì§€ì •í•´ì¤ë‹ˆë‹¤.
        
        ```python
        def get_default_nick_name():
        		return "ê¸°ë³¸ì´ë¦„ì´ì•¼"
        
        class userSchema(BaseModel):
            nick_name: str = Field(default_factory: get_default_nick_name)
        ```
        
    - **`title` :** í•„ë“œì˜ ì œëª©ì„ ì§€ì •í•´ì„œ ìë™ìƒì„±ë˜ëŠ” ë¬¸ì„œì— ëª…ì‹œí•©ë‹ˆë‹¤.
        
        ```python
        class userSchema(BaseModel):
            nick_name: str = Field(title: "ë‹‰ë„¤ì„")
        ```
        
    - **`description` :** í•„ë“œì— ëŒ€í•œ ì„¤ëª…ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
        
        ```python
        class userSchema(BaseModel):
            nick_name: str = Field(description: "ì´ê±´ ìœ ì € ë‹‰ë„¤ì„ì˜ ëŒ€í•œ í•„ë“œì…ë‹ˆë‹¤.")
        ```
        
    - **`example` :** í•„ë“œì˜ ëŒ€í•œ ì˜ˆì œë¥¼ ë³´ì—¬ì¤„ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        
        ```python
        class userSchema(BaseModel):
            nick_name: str = Field(example: "ìˆ˜ë³´ì‹ì ‘ê·¼"
        ```
        
    - **`min_length`, `max_length` :** í•„ë“œì˜ ëŒ€í•œ ìµœì†Œ,ìµœëŒ“ê°’ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        
        ```python
        class userSchema(BaseModel):
            nick_name: str = Field(min_length: 3, max_length: 6)
        ```
        
        â†’ ìµœì†Œ ê¸¸ì´ 3, ìµœëŒ€ê¸¸ì´ 6
        
    - **`gt`**, **`ge`, `lt`**, **`le`**: **ìˆ«ì í•„ë“œì¼ ê²½ìš° í•´ë‹¹ ê°’ì´ í¬ê±°ë‚˜ ì‘ì€ì§€ í™•ì¸í•´ì¤ë‹ˆë‹¤.**
        
        ```python
        class userSchema(BaseModel):
            answer: int = Field(gt=0, lt=5)
        ```
        
        â†’ 1 ~ 4 ì‚¬ì´ ì •ìˆ˜ê°’ë§Œ ì…ë ¥ê°€ëŠ¥ í•˜ë‹¤.
        
        - `t` vs `e` â†’ `t` ê°™ì€ ê²½ìš° í•´ë‹¹ ìˆ«ì ë¯¸í¬í•¨, `e` ê°™ì€ ê²½ìš° í•´ë‹¹ ìˆ«ì í¬í•¨
    - **`regex` :** í•´ë‹¹ í•„ë“œì— ì •ê·œì‹ì„ ì ìš©ì‹œì¼œì„œ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ ë°œìƒì‹œì¼œì¤ë‹ˆë‹¤.
        
        ```python
        class userSchema(BaseModel):
            nick_name: str = Field(regex=r"^[a-zA-Z0-9_]+$"
        ```
        
    - **`alias` :** í•„ë“œì˜ ë³„ì¹­ì„ ì§€ì •í•˜ì—¬ì„œ JSON ì§ë ¬í™” ì—­ì§ë ¬í™” ì‹œ ì‚¬ìš©ë˜ëŠ” ì´ë¦„ì„ ë³€ê²½
        
        ```python
        class userSchema(BaseModel):
            nick_name: str = Field(alias = "_id") 
        ```
        
        â†’ mongodb ì—ì„œ _id ë¥¼ í†µí•´ ì ‘ê·¼í• ìˆ˜ ìˆê³  ì¶”í›„ì— JSON ìœ¼ë¡œ ë³€í™˜ ì‹œì¼°ì„ë•Œ _id í•„ë“œë¡œ ì¶œë ¥
        
        ```python
        user_data = {"_id": "123", "name": "Alice", "email": "alice@example.com"}
        user = User(**user_data)  # _idëŠ” idë¡œ ë§¤í•‘ë¨
        print(user.id)  # ì¶œë ¥: 123
        ```
        
        ```python
        user = User(id="123", name="Alice", email="alice@example.com")
        print(user.json())  # ì¶œë ¥: {"_id": "123", "name": "Alice", "email": "alice@example.com"}
        ```
        
    - **`nullable`:** í•´ë‹¹ í•„ë“œê°€ None ê°’ì„ ê°€ì§ˆ ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
        
        ```python
        class userSchema(BaseModel):
            nick_name: str = Field(nullable= True)
        ```
        
    - `. . .`  : í•´ë‹¹ í•„ë“œê°€ ê¼­í•„ìš”í•˜ë‹¤ëŠ” ê²ƒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
        
        ```python
        class userSchema(BaseModel):
            nick_name: str = Field(...)
        ```
        
        â†’ í•´ë‹¹ nick_name í•„ë“œê°€ ì—†ì„ ê²½ìš° ì˜¤ë¥˜ ë°œìƒ
        

### ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    await startup_db_client(app)
    yield
    await shutdown_db_client(app)

async def startup_db_client(app):
    try:
        app.mongodb_client = AsyncIOMotorClient(os.getenv("DATABASE_URL"))
        app.mongodb = app.mongodb_client.get_database("SolPict")
        print("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.ğŸ™†â€â™‚ï¸")
    except Exception as error:
        print("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.ğŸ™…â€â™‚ï¸", error)

async def shutdown_db_client(app):
    app.mongodb_client.close()
    print("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤.ğŸ™‡â€â™‚ï¸")

app = FastAPI(lifespan=lifespan)
```

- `asynccontextmanager`  (https://fastapi.tiangolo.com/advanced/events/?h=#async-context-manager)
    
    â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œì‘ë˜ê¸°ì „ ê³¼ ì¢…ë£Œ ë ë•Œ(ìˆ˜ëª…: ìš”ì²­ì˜ ì‹œì‘ê³¼ ë) ì‹¤í–‰ë˜ì–´ì•¼ í•˜ëŠ” ì½”ë“œë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    - `yield` : í•´ë‹¹ ì½”ë“œë¥¼ í†µí•´ ì „ì— ì‹¤í–‰ì‹œí‚¬ì§€ ì¢…ë£Œ í•˜ê³  ì‹¤í–‰ì‹œí‚¬ì§€ë¥¼ êµ¬ë¶„ì§€ì–´ ì¤ë‹ˆë‹¤.
    - **ë¹„ë™ê¸° ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ìë¡œ** `async with`ì™€ í•¨ê»˜ ì‚¬ìš©í•©ë‹ˆë‹¤
- `AsyncIOMotorClient(DATABASE_URL)`
    
    â†’ ë°ì´í„°ë² ì´ìŠ¤ ì£¼ì†Œì™€ ì—°ê²°ì‹œì¼œì¤ë‹ˆë‹¤.
    
- `.get_database(â€ì €ì¥ì†Œâ€)`
    
    â†’ ì—°ê²°ëœ ë°ì´í„°ë² ì´ìŠ¤ íŠ¹ì • ì €ì¥ì†Œì— ì ‘ê·¼í•˜ê²Œ í•´ì¤ë‹ˆë‹¤.
    
    - ê·¸ë’¤ë¡œ [â€í´ë”ëª…â€] ì„ ë” ë¶™ì—¬ì„œ ì„¸ë¶€ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    ```python
    app.mongodb_client = AsyncIOMotorClient(os.getenv("DATABASE_URL"))  #ë‚´ ë°ì´í„°ë² ì´ìŠ¤ ì™€ ì—°ê²°
    app.mongodb = app.mongodb_client.get_database("SolPict")     # í•´ë‹¹ ë°ì´í„°ë² ì´ìŠ¤ ë‚´ì—ì„œ íŠ¹ì • ì €ì¥ì†Œì— ì ‘ê·¼ 
    
    def get_collection_users(request: Request):
        return app.mongodb["users"]               # "SolPict"ì €ì¥ì†Œ ë‚´ë¶€ì—ì„œ "users"í´ë”ë¡œ ì ‘ê·¼í•´ì¤ë‹ˆë‹¤.
        
    def get_collection_problems(request: Request):
        return app.mongodb["problems"]          # "SolPict"ì €ì¥ì†Œ ë‚´ë¶€ì—ì„œ "problems"í´ë”ë¡œ ì ‘ê·¼í•´ì¤ë‹ˆë‹¤.
    ```
    

### ë°ì´í„° CRUD

ë°ì´í„° ë„£ê¸° (Create)

```python
@app.post("/users")
async def create_user(request: Request, user: userSchema = Body(...)):
    user = jsonable_encoder(user)
    new_user = await get_collection_users(request).insert_one(user)
    create_user = await get_collection_users(request).find_one(
        {"_id": new_user.inserted_id}
    )
    return create_user
```

- `request`
    
    â†’ `request` ìš”ì²­ê°ì²´ë¡œ ì—¬ëŸ¬ ì •ë³´ë“¤ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì‚¬ìš©í•˜ì§€ ì•Šì„ ê²½ìš° ìƒëµ ê°€ëŠ¥)
    
    - ë’¤ì— Request íƒ€ì… ì§€ì •
    - HTTP ë©”ì„œë“œ, URL, í—¤ë”, ë³¸ë¬¸, ì¿ í‚¤, ë“±ë“±
- `user: userSchema`
    
    â†’ ë°›ëŠ” ìš”ì²­ ë³¸ë¬¸ì˜ `user` ë°ì´í„°ê°€ `userSchema` ì˜ í˜•íƒœë¥¼ ê°€ì ¸ì•¼í•˜ëŠ” ê²ƒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
    
- `Body(...)`
    
    â†’ ìš”ì²­ ë³¸ë¬¸ì— jsonë¥¼ í¬í•¨í•´ì•¼ í•˜ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚´ê³  ìë™ ì§ë ¬í™” ì—­ì§ë ¬í™”ë¥¼ ì‹œì¼œì¤ë‹ˆë‹¤.
    
- `user = jsonable_encoder(user)`
    
    â†’ ë°ì´í„° ë² ì´ìŠ¤ì— ì €ì¥í•˜ê¸° ìœ„í•œ ì§ë ¬í™” í˜•íƒœë¡œ ë°”ê¾¸ì–´ ì¤ë‹ˆë‹¤.
    
- `await get_collection_users(request).insert_one(user)`
- `await get_collection_users(request).find_one(ì¡°ê±´)`
    
    â†’ í•´ë‹¹ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ì†Œì— ì–´ë–¤ ì‘ì—…ì„ í• ì§€ ë©”ì„œë“œë¡œ ë‚˜íƒ€ë‚´ì–´ ì¤ë‹ˆë‹¤. 
    
    - JSON ë³€í™˜ì‹œí‚¨ user ë¥¼ ì €ì¥ì†Œì— ì €ì¥í•´ì¤ë‹ˆë‹¤.
    - ì €ì¥ì†Œì—ì„œ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.